namespace FiberEvolutionScraper.Api.Services;

using FiberEvolutionScraper.Api.Models;
using System.Globalization;
using System.Linq;
using System.Text.Json;
using System.Web.Http;

public class FiberApi
{
	HttpClient client;
	TokenParser tokenParser;
    string token;
    DateTime tokenAge = DateTime.Now;

	public FiberApi(IServiceProvider serviceProvider)
    {
        tokenParser = serviceProvider.GetRequiredService<TokenParser>();
        setToken();

        client = serviceProvider.GetRequiredService<HttpClient>();
        client.DefaultRequestHeaders.Add("AppAuthorization", $"Bearer {token}");
        client.DefaultRequestHeaders.Accept.Add(new("application/json"));
        client.DefaultRequestHeaders.Accept.Add(new("text/plain"));
        client.DefaultRequestHeaders.Accept.Add(new("*/*"));
        client.BaseAddress = new("https://couverture-eligibilite.orange.fr/");
    }

	public FiberResponseModel GetFibersForLoc(double y, double x)
    {
        setToken();
        FiberResponseModel fibers = new();
        HttpResponseMessage httpResponse;

        var offsetX = 0.006929*.7;
        var offsetY = 0.004457*.7;
        var offSets = new List<(double, double)>() {
            (0 , 0),
            (0, offsetX),
            (0, -offsetX),
            (offsetY, 0),
            (-offsetY, 0),
            (offsetY, offsetX),
            (-offsetY, -offsetX),
            (offsetY, -offsetX),
            (-offsetY, offsetX)
        };

        var i = 5;
        var modul = (i % 2 == 1 ? i / 2 : i / 2 - 0.5);
        var startPoint = (x - modul * offsetX, y - modul * offsetY);

        Parallel.For(0, i, (j) =>
        {
            Parallel.For(0, i, (k) =>
            {
                /*    
                 *    fibers.Results.Add(new FiberPoint()
                    {
                        address = new()
                        {
                            bestCoords = new FiberResponseModel.BestCoords()
                            {
                                Coord = new FiberResponseModel.Coord()
                                {
                                    X = startPoint.Item1 + k * offsetX,
                                    Y = startPoint.Item2 + j * offsetY
                                }
                            },
                            signature = j.ToString() + k.ToString()
                        },
                        eligibilitesFtth = new()
                        {
                            new()
                            {
                                etapeFtth = "MABITE"
                            }
                        }
                    });
                */
                httpResponse = client.GetAsync($"api/eligibilite/zoneAdresse?x={(startPoint.Item1 + k * offsetX).ToString(CultureInfo.InvariantCulture)}&y={(startPoint.Item2 + j * offsetY).ToString(CultureInfo.InvariantCulture)}&extendedZone=false").Result;
                var tempResult = JsonSerializer.Deserialize<FiberResponseModel>(httpResponse.Content.ReadAsStringAsync().Result).Results;
                fibers.Results.AddRange(tempResult);
                Thread.Sleep(20);
            });
        });



        var count = fibers.Results.Count;
        //fibers.Results = fibers.Results.DistinctBy((FiberPoint f) => f.address.signature).ToList();
        //fibers.Results = fibers.Results.GroupBy(f => f.address.signature).Where(e => e.Count() > 1).Select(g => g.MaxBy(d => d.eligibilitesFtth.Count)).ToList();
        fibers.Results = fibers.Results.GroupBy(f => f.address.signature).Select(g => g.MaxBy(d => d.eligibilitesFtth.Count)).ToList();
        Console.WriteLine("Delta: {0}", count - fibers.Results.Count);

        //var httpResponse = "{\"partialResult\":false,\"zoneSize\":\"VILLE\",\"results\":[{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"10\",\"extVoie\":\"\",\"signature\":\"31555_3424_10\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"10 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4532429,\"y\":43.6230028},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4531317,\"y\":43.6229929},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4532429,\"y\":43.6230028},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4532429,\"y\":43.6230028},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A26E\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"17\",\"extVoie\":\"\",\"signature\":\"31555_3424_17\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"17 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4527714,\"y\":43.6230889},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4528942,\"y\":43.6231528},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4527714,\"y\":43.6230889},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4527714,\"y\":43.6230889},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A2RO\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"17\",\"extVoie\":\"b\",\"signature\":\"31555_3424_17_B\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"17 b imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4527089,\"y\":43.6231333},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4528942,\"y\":43.6231528},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4527089,\"y\":43.6231333},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4527089,\"y\":43.6231333},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/C/A9YU\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"80\",\"extVoie\":\"\",\"signature\":\"31555_5028_80\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"80 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4539908,\"y\":43.6226494},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4539039000000002,\"y\":43.622666650000006},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4539908,\"y\":43.6226494},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":\"GAUCHE\",\"coord\":{\"coord\":{\"x\":1.4539908,\"y\":43.6226494},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/X/0A33\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"82\",\"extVoie\":\"\",\"signature\":\"31555_5028_82\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"82 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4541108,\"y\":43.6228931},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4541298000000002,\"y\":43.62286402500001},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4541108,\"y\":43.6228931},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4541108,\"y\":43.6228931},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A5EB\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"87\",\"extVoie\":\"\",\"signature\":\"31555_5028_87\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"87 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.45389935,\"y\":43.62336325},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4537145999999999,\"y\":43.6237078},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.45389935,\"y\":43.62336325},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":\"LES PAGELLES RES SENIORS\",\"coord\":{\"coord\":{\"x\":1.4537774,\"y\":43.6236454},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/X/09P0\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null},{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4540213,\"y\":43.6230811},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"PREVU_QUARTIER\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/C/H61G\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"1\",\"extVoie\":\"\",\"signature\":\"31555_3424_1\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"1 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4534846,\"y\":43.6225824},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4535197,\"y\":43.6227085},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4534846,\"y\":43.6225824},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4534846,\"y\":43.6225824},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/H5ZO\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"2\",\"extVoie\":\"\",\"signature\":\"31555_3424_2\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"2 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4536443,\"y\":43.6226556},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4535197,\"y\":43.6227085},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4536443,\"y\":43.6226556},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4536443,\"y\":43.6226556},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A13E\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"3\",\"extVoie\":\"\",\"signature\":\"31555_3424_3\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"3 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4535197,\"y\":43.6227085},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4535197,\"y\":43.6227085},\"origin\":\"REFLET_PC\",\"accuracy\":null}},\"ftthLoaded\":false,\"eligibilitesFtth\":[],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"5\",\"extVoie\":\"\",\"signature\":\"31555_3424_5\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"5 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4532844,\"y\":43.6227245},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4533194,\"y\":43.6228597},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4532844,\"y\":43.6227245},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4532844,\"y\":43.6227245},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A1N4\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"6\",\"extVoie\":\"\",\"signature\":\"31555_3424_6\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"6 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4534306,\"y\":43.6228696},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4533194,\"y\":43.6228597},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4534306,\"y\":43.6228696},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4534306,\"y\":43.6228696},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A1R6\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"7\",\"extVoie\":\"\",\"signature\":\"31555_3424_7\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"7 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.453222,\"y\":43.62276},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4533194,\"y\":43.6228597},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.453222,\"y\":43.62276},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.453222,\"y\":43.62276},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A1V0\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"8\",\"extVoie\":\"\",\"signature\":\"31555_3424_8\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"8 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4533304,\"y\":43.6229496},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4533194,\"y\":43.6228597},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4533304,\"y\":43.6229496},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4533304,\"y\":43.6229496},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A1YY\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"9\",\"extVoie\":\"\",\"signature\":\"31555_3424_9\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"9 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4531341,\"y\":43.6228402},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4533194,\"y\":43.6228597},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4531341,\"y\":43.6228402},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4531341,\"y\":43.6228402},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A22U\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"11\",\"extVoie\":\"\",\"signature\":\"31555_3424_11\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"11 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4530103,\"y\":43.6228481},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4531317,\"y\":43.6229929},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4530103,\"y\":43.6228481},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4530103,\"y\":43.6228481},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A29V\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"13\",\"extVoie\":\"\",\"signature\":\"31555_3424_13\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"13 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4527878,\"y\":43.6228283},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4531317,\"y\":43.6229929},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4527878,\"y\":43.6228283},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4527878,\"y\":43.6228283},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A2GS\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"15\",\"extVoie\":\"\",\"signature\":\"31555_3424_15\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"15 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4527253,\"y\":43.6228728},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4528942,\"y\":43.6231528},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4527253,\"y\":43.6228728},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4527253,\"y\":43.6228728},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A2MF\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"3424\",\"numVoie\":\"20\",\"extVoie\":\"\",\"signature\":\"31555_3424_20\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"imp fourcaran\",\"libAdresse\":\"20 imp fourcaran 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4530394,\"y\":43.6233607},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4528942,\"y\":43.6231528},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4530394,\"y\":43.6233607},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4530394,\"y\":43.6233607},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/C/A30U\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"81\",\"extVoie\":\"\",\"signature\":\"31555_5028_81\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"81 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4536678,\"y\":43.6227367},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4538508,\"y\":43.6228999},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4536678,\"y\":43.6227367},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4536678,\"y\":43.6227367},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A5DY\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"83\",\"extVoie\":\"\",\"signature\":\"31555_5028_83\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"83 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4537767,\"y\":43.6228904},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4538508,\"y\":43.6228999},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4537767,\"y\":43.6228904},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4537767,\"y\":43.6228904},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A5EU\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"85\",\"extVoie\":\"\",\"signature\":\"31555_5028_85\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"85 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4538129,\"y\":43.6229536},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},{\"coord\":{\"x\":1.4538508,\"y\":43.6228999},\"origin\":\"REFLET_PC\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4538129,\"y\":43.6229536},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4538129,\"y\":43.6229536},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A5G5\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":true,\"xdslFound\":true,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"020P\",\"numVoie\":\"25\",\"extVoie\":\"\",\"signature\":\"31555_020P_25\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"rue jean bartoli\",\"libAdresse\":\"25 rue jean bartoli 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4529153,\"y\":43.6225867},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4529153,\"y\":43.6225867},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":\"PAV11 COEUR LAPUJADE\",\"coord\":{\"coord\":{\"x\":1.4529153,\"y\":43.6225867},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/X/09I7\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":false,\"xdslFound\":false,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null},{\"address\":{\"codeCommune\":\"31555\",\"codeVoie\":\"5028\",\"numVoie\":\"95\",\"extVoie\":\"\",\"signature\":\"31555_5028_95\",\"codePostal\":\"31000\",\"libCommune\":\"toulouse\",\"libVoie\":\"ch de lapujade\",\"libAdresse\":\"95 ch de lapujade 31000 toulouse\",\"coords\":[{\"coord\":{\"x\":1.4541475,\"y\":43.6237203},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}],\"streetHasNumber\":false,\"bestCoords\":{\"coord\":{\"x\":1.4541475,\"y\":43.6237203},\"origin\":\"REFLET_FTTH\",\"accuracy\":null}},\"ftthLoaded\":true,\"eligibilitesFtth\":[{\"batiment\":null,\"coord\":{\"coord\":{\"x\":1.4541475,\"y\":43.6237203},\"origin\":\"REFLET_FTTH\",\"accuracy\":null},\"etapeFtth\":\"ELLIGIBLE\",\"dateDebutEligibilite\":null,\"syndicStatusCode\":null,\"codeImb\":\"IMB/31555/S/A5KH\",\"dateMescFT\":null,\"etatImmeuble\":null,\"etatImmeuble360\":null}],\"xdslLoaded\":false,\"xdslFound\":false,\"xdslOffresLoaded\":false,\"offres\":[],\"elig360\":null,\"mobileCoverage\":null}]}";
        //      var result = JsonSerializer.Deserialize<FiberResponseModel>(httpResponse);

        return fibers;
	}

    private void setToken()
    {
        if (token == null || tokenAge < tokenAge.AddHours(-2))
        {
            token = tokenParser.GetToken(GetOrangeToken(tokenParser.GenerateAppId()));
            tokenAge = DateTime.Now;
        }
    }

	public string GetOrangeToken(string appId)
	{
		var httpClient = new HttpClient();
		httpClient.DefaultRequestHeaders.Add("appId", appId);
		var result = httpClient.GetAsync("https://couverture-eligibilite.orange.fr/api/appConfig.json").Result;
		return result.Headers.GetValues("Token").FirstOrDefault();
	}
}
